{% extends "base/base.html" %}
{% load staticfiles %}

{% block head %}
<link rel="stylesheet" href="{% static "typeahead/typeahead.css" %}" />
<link rel="stylesheet" href="{% static "chosen/chosen.css" %}" />
<style type="text/css">
    #map-canvas { width: 100%; height: 500px; margin: 0; padding: 0;}
    #map-canvas img {max-width: none;}
</style>
{% endblock %}


{% block title %}Create Project{% endblock %}

{% block body %}

<div class='row'>
    <div class='large-12 columns'>
        {% if project.id %}
        <h1>Edit Project</h1>
        {% else %}
        <h1>Create Project</h1>
        {% endif %}
    </div>
</div>
<div class="row white-section">
    <div class="large-12 columns">
        <form method="POST" enctype="multipart/form-data" id="project_form">
              {% csrf_token %}
              {% for error in form.non_field_errors %}
            <div data-alert class="alert-box alert">
                {{ error }}
                <a href="#" class="close">&times;</a>
              </div>
            {% endfor %}

            <div class="row">
                <div class="medium-12 columns">
                    {% include "base/partials/tooltip_formfield.html" with field=form.title %}
                    <span>Categories</span>
                    <select data-placeholder="Choose some categories..." class="chosen-select" multiple tabindex="4">
                        <option value=""></option>
                        {% for category in valid_categories %}
                            {% if project.id and category in project.categories %}
                                <option value="{{category}}" selected>{{category}}</option>
                            {% else %}
                                <option value="{{category}}">{{category}}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    {% include "base/partials/tooltip_formfield.html" with field=form.funding_goal %}
                    {% include "base/partials/tooltip_formfield.html" with field=form.location %}
                    {% include "base/partials/tooltip_formfield.html" with field=form.impact_power %}
                    {% include "base/partials/tooltip_formfield.html" with field=form.end_date %}
                    {% include "base/partials/tooltip_formfield.html" with field=form.video_url %}
                    {% include "base/partials/tooltip_formfield.html" with field=form.solar_url %}
                    {% include "base/partials/tooltip_formfield.html" with field=form.cover_photo %}
                    {% include "base/partials/tooltip_formfield.html" with field=form.org_name %}
                    {% include "base/partials/tooltip_formfield.html" with field=form.mission_statement %}
                    {% include "base/partials/tooltip_formfield.html" with field=form.org_start_date %}
                    {% include "base/partials/tooltip_formfield.html" with field=form.org_about %}
                    {% include "base/partials/tooltip_formfield.html" with field=form.internal_rate_return %}
                    <div class="hide">
                        {% include "base/partials/tooltip_formfield.html" with field=form.categories_list %}
                        {% include "base/partials/tooltip_formfield.html" with field=form.location_latitude %}
                        {% include "base/partials/tooltip_formfield.html" with field=form.location_longitude %}
                    </div>
                </div>
                <div class="medium-12 columns">
                    <div id="map-canvas"></div>
                </div>
            </div>
            <button class="large right" id="save_project" type="submit">Save</button>
        </form>
    </div>
</div>

{% endblock %}

{% block javascripts %}
<!-- Initializes the Google Map / Location Selection Typeahead -->
<script type="text/javascript"
    src="https://maps.googleapis.com/maps/api/js?key={{GOOGLEMAPS_API_KEY}}&libraries=places">
</script>
<script src="{% static 'typeahead/typeahead.bundle.js' %}"></script>
<script src="{% static 'typeahead/typeahead-addresspicker.js' %}"></script>
<script type="text/javascript">
    $( function() {
        // gets the start location of the map
        {% if project.location_latitude %}
            var latitude = {{project.location_latitude}};
        {% else %}
            var latitude = 37.7699298;
        {% endif %}

        {% if project.location_longitude %}
            var longitude = {{project.location_longitude}};
        {% else %}
            var longitude = -122.4469157;
        {% endif %}
        var startLocation = new google.maps.LatLng(latitude, longitude);
        // instantiate the addressPicker suggestion engine (based on bloodhound)
        // https://github.com/sgruhier/typeahead-addresspicker
        var addressPicker = new AddressPicker({
            map: {
                center: startLocation,
                id: '#map-canvas',
                displayMarker: true,
                zoom: 18
            },
            marker: {
                position: startLocation,
                visible: true,
                draggable: false
            },
            zoomForLocation: 18,
            draggable: false,
            reverseGeocoding: true,
            utocompleteService: {
                componentRestrictions: {
                    country: 'US'
                }
            }
        });
        // instantiate the typeahead UI
        $('#id_location').typeahead(null, {
            displayKey: 'description',
            source: addressPicker.ttAdapter()
        });
        // add click listeners
        addressPicker.bindDefaultTypeaheadEvent($('#id_location'))
        $(addressPicker).on('addresspicker:selected', function (event, result) {
            $('#id_location_latitude').val(result.lat());
            $('#id_location_longitude').val(result.lng());
        });

        $("#project_form").on('submit', function(e) {
            if (!$('#id_location_latitude').val() || !$('#id_location_longitude').val()) {
                toastr.options.positionClass = "toast-bottom-right";
                toastr.error("Please enter a valid address");
                e.preventDefault();
                return false;
            }
        });
    });
</script>
<!-- Initializes the category selection tool -->
<script src="{% static 'chosen/chosen.jquery.js' %}"></script>
<script src="{% static 'chosen/docsupport/prism.js' %}" type="text/javascript" charset="utf-8"></script>
<script>
    $( document ).ready(function() {
        // populates the currently selected categories if some of them have been selected already
        {% if project.id %}
        var current_categories = "{{project.categories}}";
        current_categories = current_categories.split("&#39;").join("");
        current_categories = current_categories.split(" ").join("");
        current_categories = current_categories.substring(1, current_categories.length - 1);
        $('#id_categories_list').val(current_categories);
        {% endif %}

        // initializes chosen
        $(".chosen-select").chosen();
        // sets the on change listener to update the hidden input field whenever categories are updated
        $('.chosen-select').on('change', function(evt, params) {
            categories_list = $(".chosen-select").chosen().val();
            $('#id_categories_list').val(categories_list);
        });
    });
</script>

{% endblock %}
